<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Register — Perpustakaan Digital</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

<style>
  :root{
    --glass-bg: rgba(255,255,255,.10);
    --glass-br: 18px;
    --glass-bd: 1px solid rgba(255,255,255,.22);
    --text: #f8fafc;
    --muted: #cbd5e1;
    --accent: #22d3ee;
    --accent-2: #6366f1;
    --success: #22c55e;
    --danger: #ef4444;
  }
  [data-theme="light"]{
    --glass-bg: rgba(255,255,255,.7);
    --glass-br: 18px;
    --glass-bd: 1px solid rgba(0,0,0,.06);
    --text: #0f172a;
    --muted: #475569;
    --accent: #2563eb;
    --accent-2: #06b6d4;
  }

  html, body {
    height: 100%;
    margin: 0;
}

body {
    font-family: 'Varela Round', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: var(--text);
    background: radial-gradient(1200px 800px at 70% 10%, rgba(255,255,255,.08), transparent),
                linear-gradient(135deg,#0b1024 0%, #0e1634 35%, #0a1230 100%);
    overflow-x: hidden; /* biar nggak ada scroll horizontal */
}

  /* Background bintang */
  canvas#stars, canvas#stars2{ position:fixed; inset:0; z-index:0; display:block; }

  .top-actions{
    position: fixed; z-index:3; top:14px; right:14px; display:flex; gap:8px;
  }

  .wrap {
    position: relative;
    z-index: 2;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    overflow-y: auto;  /* ✅ aktifkan scroll untuk isi */
}
  .card-reg{
    width:100%; max-width:720px; border-radius:var(--glass-br);
    background:var(--glass-bg); border:var(--glass-bd);
    box-shadow:0 10px 50px rgba(0,0,0,.35); backdrop-filter: blur(10px);
    overflow: hidden;
  }

  .hero{
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    color:#fff; padding:22px 22px;
  }
  .hero .brand{
    display:flex; align-items:center; gap:10px;
  }
  .hero .logo{
    width:42px; height:42px; border-radius:12px; display:grid; place-items:center;
    background: rgba(255,255,255,.18);
  }

  .content{ padding:22px; }

  .form-label{ color:var(--muted); margin-bottom:.35rem; }

  /* Input group dengan garis pemisah */
  .input-group .btn, .input-group .input-group-text{ border-color: rgba(255,255,255,.25); }
  .input-group .input-group-text{ background: rgba(255,255,255,.12); color:var(--muted); }
  .input-group .divider{
    width:1px; background: rgba(0,0,0,.1); margin:0 .35rem; align-self:stretch;
  }
  [data-theme="dark"] .input-group .divider{ background: rgba(255,255,255,.15); }

  .form-control{
    background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.22);
    color: var(--text);
  }
  .form-control::placeholder{ color: #cbd5e180; }
  .form-control:focus{
    border-color: var(--accent);
    box-shadow: 0 0 0 .2rem rgba(34,211,238,.15);
    background: rgba(255,255,255,.16);
    color: var(--text);
  }

  .btn-primary{
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    border:0; transition: transform .15s ease, box-shadow .2s ease;
  }
  .btn-primary:hover{
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(99,102,241,.35);
  }
  .btn-outline-light{ border-color: rgba(255,255,255,.35); color: var(--text); }
  [data-theme="light"] .btn-outline-light{ border-color: rgba(0,0,0,.2); }

  /* Password strength + checklist */
  .strength{ height:8px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,.18); }
  .strength > span{ display:block; height:100%; width:0%; transition: width .25s ease, background .25s ease;
                    background: linear-gradient(90deg, #ef4444, #f59e0b, #22c55e); }
  .checklist{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
  .chip{
    display:inline-flex; align-items:center; gap:6px; padding:.25rem .55rem; border-radius:999px;
    border:1px dashed rgba(255,255,255,.35); color:var(--muted); font-size:.85rem;
  }
  .chip.ok{ border-color: rgba(34,197,94,.6); color: #bbf7d0; }
  [data-theme="light"] .chip{ border-color: rgba(0,0,0,.2); color:#64748b; }
  [data-theme="light"] .chip.ok{ border-color: rgba(34,197,94,.6); color:#0f5132; background:#dcfce7; }

  /* Upload avatar drag & drop */
  .dropzone{
    border: 2px dashed rgba(255,255,255,.35); border-radius: 14px; padding:14px;
    text-align:center; cursor:pointer; transition: background .2s ease, border-color .2s ease;
  }
  .dropzone.drag{ background: rgba(255,255,255,.08); border-color: var(--accent); }
  .avatar{
    width:100px; height:100px; border-radius:50%; object-fit:cover; display:none; margin:auto;
    box-shadow: 0 8px 24px rgba(0,0,0,.25);
  }

  .muted{ color:var(--muted); }
  a{ color: var(--accent); text-decoration: none; }
  a:hover{ text-decoration: underline; }
</style>
</head>
<body>

<!-- BG Bintang dua layer -->
<canvas id="stars"></canvas>
<canvas id="stars2"></canvas>

<!-- Toggle theme -->
<div class="top-actions">
  <button id="themeToggle" class="btn btn-sm btn-outline-light" title="Light/Dark">
    <i class="bi bi-brightness-high"></i>
  </button>
</div>

<div class="wrap">
  <div class="card-reg">
    <div class="hero">
      <div class="brand">
        <div class="logo"><i class="bi bi-stars"></i></div>
        <div>
          <h4 class="mb-0 fw-bold">Buat Akun Baru</h4>
          <small class="opacity-75">Perpustakaan Digital</small>
        </div>
      </div>
    </div>

    <div class="content">
      <!-- Alert atas form -->
      <div id="topAlert" class="alert alert-danger d-none" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span id="topAlertMsg">Ada input yang belum valid.</span>
      </div>

      <form id="registerForm" action="register.php" method="post" enctype="multipart/form-data" novalidate>
        <input type="hidden" name="csrf_token" id="csrfToken">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="nisn">NISN</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-hash"></i></span>
              <input type="text" inputmode="numeric" pattern="[0-9]{8,20}" maxlength="20"
                     class="form-control" id="nisn" name="nisn" placeholder="Contoh: 1234567890" required>
            </div>
            <small class="muted">Hanya angka, min 8 digit.</small>
          </div>

          <div class="col-md-6">
            <label class="form-label" for="nama">Nama Lengkap</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-person"></i></span>
              <input type="text" class="form-control" id="nama" name="nama" placeholder="Nama sesuai identitas" required>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label" for="email">Email</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-envelope"></i></span>
              <input type="email" class="form-control" id="email" name="email" placeholder="nama@domain.com" required>
            </div>
            <small id="emailHint" class="muted"></small>
          </div>

          <div class="col-md-6">
            <label class="form-label" for="password">Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
              <input type="password" class="form-control" id="password" name="password" placeholder="Minimal 8 karakter" required>
              <div class="divider"></div>
              <button class="btn btn-outline-light" type="button" id="togglePassword" title="Tampilkan/Sembunyikan">
                <i class="bi bi-eye-slash"></i>
              </button>
              <button class="btn btn-outline-light" type="button" id="genPass" title="Buat sandi acak">
                <i class="bi bi-magic"></i>
              </button>
              <button class="btn btn-outline-light" type="button" id="copyPass" title="Salin sandi">
                <i class="bi bi-clipboard-check"></i>
              </button>
            </div>
            <div class="strength mt-2"><span id="strengthBar"></span></div>
            <div class="checklist" id="pwChecklist">
              <div class="chip" data-rule="len"><i class="bi bi-dot"></i> ≥ 8 karakter</div>
              <div class="chip" data-rule="upper"><i class="bi bi-dot"></i> Huruf besar</div>
              <div class="chip" data-rule="lower"><i class="bi bi-dot"></i> Huruf kecil</div>
              <div class="chip" data-rule="num"><i class="bi bi-dot"></i> Angka</div>
              <div class="chip" data-rule="sym"><i class="bi bi-dot"></i> Simbol</div>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Foto Profil</label>
            <div class="dropzone" id="dropzone">
              <input type="file" class="form-control d-none" id="foto" name="foto" accept=".jpg,.jpeg,.png" required>
              <div class="d-flex flex-column align-items-center gap-2">
                <img id="avatar" class="avatar" alt="Preview Foto">
                <div class="muted"><i class="bi bi-cloud-arrow-up"></i> Seret & letakkan file ke sini atau klik untuk pilih</div>
                <small class="muted">Format JPG/PNG, maks 2MB.</small>
                <div class="d-flex gap-2">
                  <button type="button" id="pickBtn" class="btn btn-sm btn-outline-light"><i class="bi bi-folder2-open"></i> Pilih</button>
                  <button type="button" id="clearBtn" class="btn btn-sm btn-outline-light d-none"><i class="bi bi-x-circle"></i> Hapus</button>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 d-flex justify-content-between align-items-center mt-2">
            <a href="login.html" class="muted"><i class="bi bi-box-arrow-in-right"></i> Sudah punya akun? Login</a>
            <button type="submit" name="submit" class="btn btn-primary">
              <i class="bi bi-person-plus"></i> Register
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1100">
  <div id="liveToast" class="toast text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastMsg"><i class="bi bi-info-circle me-2"></i> Info.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ============== Theme Toggle ============== */
const themeBtn = document.getElementById('themeToggle');
(function syncTheme(){
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
})();
themeBtn.addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  const next = (cur === 'dark') ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
});

/* ============== Canvas Stars (dua layer) ============== */
const c1 = document.getElementById('stars'),  ctx1 = c1.getContext('2d');
const c2 = document.getElementById('stars2'), ctx2 = c2.getContext('2d');
function fitCanvas(){ [c1,c2].forEach(c=>{ c.width = innerWidth; c.height = innerHeight; }); }
addEventListener('resize', fitCanvas); fitCanvas();
function makeStars(n, smin, smax, rmin, rmax, cw, ch){
  const arr=[]; for(let i=0;i<n;i++) arr.push({x:Math.random()*cw,y:Math.random()*ch,r:rmin+Math.random()*(rmax-rmin),v:smin+Math.random()*(smax-smin),tw:Math.random()*Math.PI*2});
  return arr;
}
let starsA = makeStars(120,.002,.01,.6,1.6,c1.width,c1.height);
let starsB = makeStars(60,.004,.015,1.0,2.2,c2.width,c2.height);
function draw(ctx, arr){
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
  for(const s of arr){ s.tw+=s.v; const op=.4+Math.sin(s.tw)*.4; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fillStyle=`rgba(255,255,255,${op.toFixed(2)})`; ctx.fill(); }
}
(function loop(){ draw(ctx1,starsA); draw(ctx2,starsB); requestAnimationFrame(loop); })();

/* ============== Helpers ============== */
function toast(msg){
  document.getElementById('toastMsg').innerHTML = msg;
  new bootstrap.Toast(document.getElementById('liveToast')).show();
}
const topAlert = document.getElementById('topAlert'); const topAlertMsg = document.getElementById('topAlertMsg');
function showTopAlert(msg){ topAlertMsg.innerHTML = msg; topAlert.classList.remove('d-none'); }
function hideTopAlert(){ topAlert.classList.add('d-none'); }

/* ============== Form Elements ============== */
const form   = document.getElementById('registerForm');
const nisn   = document.getElementById('nisn');
const nama   = document.getElementById('nama');
const email  = document.getElementById('email');
const emailHint = document.getElementById('emailHint');
const passEl = document.getElementById('password');
const togglePass = document.getElementById('togglePassword');
const genPass = document.getElementById('genPass');
const copyPass = document.getElementById('copyPass');
const strengthBar = document.getElementById('strengthBar');
const pwChecklist = document.getElementById('pwChecklist');
const fotoInput = document.getElementById('foto');
const avatar = document.getElementById('avatar');
const dropzone = document.getElementById('dropzone');
const pickBtn = document.getElementById('pickBtn');
const clearBtn = document.getElementById('clearBtn');

fetch('csrf_token.php')
  .then(r => r.text())
  .then(token => { document.getElementById('csrfToken').value = token.trim(); });

/* ============== NISN numeric & panjang ============== */
nisn.addEventListener('input', ()=>{
  nisn.value = nisn.value.replace(/\D/g,'').slice(0,20);
});

/* ============== Email suggestion (typo domain) ============== */
const commonDomains = ["gmail.com","yahoo.com","outlook.com","hotmail.com","icloud.com"];
function lev(a,b){
  const an=a.length, bn=b.length; if(!an) return bn; if(!bn) return an;
  const m=Array.from({length:an+1},(_,i)=>[i]); for(let j=1;j<=bn;j++) m[0][j]=j;
  for(let i=1;i<=an;i++){ for(let j=1;j<=bn;j++){
    const c=a[i-1]===b[j-1]?0:1; m[i][j]=Math.min(m[i-1][j]+1, m[i][j-1]+1, m[i-1][j-1]+c);
  }}
  return m[an][bn];
}
email.addEventListener('blur', ()=>{
  const v = email.value.trim(); const m = v.match(/@(.+)$/); if(!m) return emailHint.textContent='';
  const dom = m[1].toLowerCase(); let best=10, sug='';
  for(const d of commonDomains){ const dist=lev(dom,d); if(dist<best){best=dist; sug=d;} }
  if(best>0 && best<=2){
    emailHint.innerHTML = `Maksud Anda <b>${v.replace(/@.+$/,'@'+sug)}</b>?`;
  }else emailHint.textContent='';
});

/* ============== Password strength + checklist ============== */
function updateStrength(){
  const v = passEl.value;
  const rules = {
    len: v.length>=8,
    upper: /[A-Z]/.test(v),
    lower: /[a-z]/.test(v),
    num: /[0-9]/.test(v),
    sym: /[^A-Za-z0-9]/.test(v),
  };
  let score = Object.values(rules).filter(Boolean).length;
  const pct = Math.min(100, score*20);
  strengthBar.style.width = pct+'%';
  const chips = pwChecklist.querySelectorAll('.chip');
  chips.forEach(ch=>{
    const key = ch.getAttribute('data-rule');
    ch.classList.toggle('ok', !!rules[key]);
    ch.querySelector('i').className = rules[key] ? 'bi bi-check-circle' : 'bi bi-dot';
  });
}
passEl.addEventListener('input', updateStrength);

/* Toggle mata */
togglePass.addEventListener('click', ()=>{
  const t = passEl.type==='password' ? 'text' : 'password';
  passEl.type=t;
  const i = togglePass.querySelector('i');
  i.classList.toggle('bi-eye');
  i.classList.toggle('bi-eye-slash');
});

/* Generator password acak (mudah dibaca + aman) */
function genPassword(len=12){
  const upp="ABCDEFGHJKLMNPQRSTUVWXYZ";
  const low="abcdefghijkmnopqrstuvwxyz";
  const num="23456789";
  const sym="!@#$%^&*?";
  const all=upp+low+num+sym;
  let out = upp[Math.floor(Math.random()*upp.length)]
          + low[Math.floor(Math.random()*low.length)]
          + num[Math.floor(Math.random()*num.length)]
          + sym[Math.floor(Math.random()*sym.length)];
  for(let i=out.length;i<len;i++){
    out += all[Math.floor(Math.random()*all.length)];
  }
  return out.split('').sort(()=>Math.random()-0.5).join('');
}
genPass.addEventListener('click', ()=>{
  passEl.value = genPassword(12);
  updateStrength();
  toast('Sandi acak telah dibuat.');
});
copyPass.addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText(passEl.value||''); toast('Sandi disalin ke clipboard.'); }catch{}
});

/* ============== Upload foto: pick, drag&drop, preview, hapus ============== */
function setPreview(file){
  if(!file) return;
  if(!/image\/(jpeg|png)/.test(file.type)){ toast('Format harus JPG/PNG.'); return; }
  if(file.size > 2*1024*1024){ toast('Ukuran maksimum 2MB.'); return; }
  const url = URL.createObjectURL(file);
  avatar.src = url; avatar.style.display='block';
  clearBtn.classList.remove('d-none');
}
pickBtn.addEventListener('click', ()=> fotoInput.click());
fotoInput.addEventListener('change', ()=>{ if(fotoInput.files[0]) setPreview(fotoInput.files[0]); });

;['dragenter','dragover'].forEach(ev=>{
  dropzone.addEventListener(ev,(e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('drag'); });
});
;['dragleave','drop'].forEach(ev=>{
  dropzone.addEventListener(ev,(e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('drag'); });
});
dropzone.addEventListener('drop', (e)=>{
  const file = e.dataTransfer.files && e.dataTransfer.files[0];
  if(file){ fotoInput.files = e.dataTransfer.files; setPreview(file); }
});
dropzone.addEventListener('click', (e)=>{
  if(e.target.closest('#pickBtn') || e.target.closest('#clearBtn')) return;
  fotoInput.click();
});
clearBtn.addEventListener('click', ()=>{
  fotoInput.value=''; avatar.style.display='none'; avatar.src=''; clearBtn.classList.add('d-none');
});

/* ============== Validasi client & submit ============== */
form.addEventListener('submit', (e)=>{
  hideTopAlert();

  // Validasi cepat
  const bad = [];
  if(!/^[0-9]{8,20}$/.test(nisn.value.trim())) bad.push('NISN harus 8–20 digit angka.');
  if(nama.value.trim().length<2) bad.push('Nama belum valid.');
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value.trim())) bad.push('Format email tidak valid.');
  const v = passEl.value;
  const passOK = v.length>=8 && /[A-Z]/.test(v) && /[a-z]/.test(v) && /[0-9]/.test(v) && /[^A-Za-z0-9]/.test(v);
  if(!passOK) bad.push('Password belum memenuhi syarat.');

  if(!fotoInput.files || !fotoInput.files[0]) bad.push('Foto profil belum dipilih.');

  if(bad.length){
    e.preventDefault();
    showTopAlert(bad.join('<br>'));
    toast('Periksa kembali data yang belum valid.');
    return;
  }

  // Tombol loading
  const btn = form.querySelector('button[type="submit"]');
  btn.disabled = true;
  const old = btn.innerHTML;
  btn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span> Mengirim...`;
  // biarkan submit lanjut ke register.php
});

 // === TAMPILKAN ERROR DARI SERVER VIA ?err= ===
  (function(){
    const params = new URLSearchParams(location.search);
    const msg = params.get('err');
    if (msg) {
      document.getElementById('topAlertMsg').textContent = msg;
      document.getElementById('topAlert').classList.remove('d-none');
      // bersihkan query biar gak muncul terus saat refresh
      history.replaceState({}, '', location.pathname);
    }
  })();
</script>
</body>
</html>
